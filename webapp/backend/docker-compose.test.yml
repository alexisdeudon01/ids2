version: '3.8'

services:
  # ==========================================================================
  # IDS Test Runner
  # ==========================================================================
  ids-test:
    build:
      context: .
      dockerfile: Dockerfile.test
    container_name: ids-test-runner
    environment:
      - PYTHONPATH=/app/src
      - PYTEST_ARGS=-v --tb=short
    volumes:
      - ./src:/app/src:ro
      - ./tests:/app/tests
      # Mount config.yaml only if it exists, otherwise use defaults
      - ./config.yaml:/app/config.yaml:ro
      # Use mounted volume for test results instead of /tmp
      - test-results:/app/test-results
    networks:
      - ids-test-network
    command: >
      python -m pytest tests/ -v --tb=short 
      --cov=src/ids --cov-report=term-missing 
      --cov-report=html:/app/test-results/htmlcov
      --junitxml=/app/test-results/junit.xml
      --log-file=/app/test-results/pytest.log

  # ==========================================================================
  # Unit Tests Only
  # ==========================================================================
  ids-unit-test:
    build:
      context: .
      dockerfile: Dockerfile.test
    container_name: ids-unit-test
    environment:
      - PYTHONPATH=/app/src
    volumes:
      - ./src:/app/src:ro
      - ./tests:/app/tests:ro
    networks:
      - ids-test-network
    command: python -m pytest tests/unit/ -v --tb=short -m "not aws"

  # ==========================================================================
  # Integration Tests (with mocked AWS)
  # ==========================================================================
  ids-integration-test:
    build:
      context: .
      dockerfile: Dockerfile.test
    container_name: ids-integration-test
    environment:
      - PYTHONPATH=/app/src
      # Note: These are placeholder values for testing. Real AWS credentials should
      # be provided via environment variables or AWS credentials file in production.
      - AWS_ACCESS_KEY_ID=testing
      - AWS_SECRET_ACCESS_KEY=testing
      - AWS_DEFAULT_REGION=eu-central-1
    volumes:
      - ./src:/app/src:ro
      - ./tests:/app/tests:ro
    networks:
      - ids-test-network
    command: python -m pytest tests/integration/ -v --tb=short

  # ==========================================================================
  # Lint & Type Check
  # ==========================================================================
  ids-lint:
    build:
      context: .
      dockerfile: Dockerfile.test
    container_name: ids-lint
    volumes:
      - ./src:/app/src:ro
      - ./tests:/app/tests:ro
    command: >
      sh -c "
        echo '=== Running flake8 ===' &&
        pip install flake8 --quiet &&
        if flake8 src/ --max-line-length=120 --ignore=E501,W503; then
          echo '=== Lint passed ==='
        else
          echo '=== Lint failed (check output above) ==='
          exit 1
        fi
      "

networks:
  ids-test-network:
    driver: bridge

volumes:
  test-results:
